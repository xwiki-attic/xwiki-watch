<?xml version="1.0" encoding="ISO-8859-1"?>

<xwikidoc>
<web>WatchCode</web>
<name>LoadingStatus</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.LudovicDubost</creator>
<author>XWiki.LudovicDubost</author>
<customClass></customClass>
<contentAuthor>XWiki.LudovicDubost</contentAuthor>
<creationDate>1181132502000</creationDate>
<date>1182156536000</date>
<contentUpdateDate>1182156536000</contentUpdateDate>
<version>1.3</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<content>&lt;h2&gt;Watch Loading status&lt;/h2&gt;

&lt;%

// make sure loading is started
if (request.space) {
 if (request.force=="1") {
  xwiki.feed.getUpdateThread(request.space).update();
 } else {
  xwiki.feed.startUpdateFeedsInSpace(request.space, 19000);
def updateThread = xwiki.feed.getUpdateThread(request.space);

println "* ${msg.get("watch.updateactive")}: true"
println "* ${msg.get("watch.updateinprogress")}: " + updateThread.isUpdateInProgress()


sql = "select count(*) from XWikiDocument as doc, BaseObject as obj where doc.web='${request.space}' and doc.fullName=obj.name and obj.className='XWiki.FeedEntryClass'"
nb = xwiki.search(sql)[0]
println "* ${msg.get("watch.nbtotalarticles")}: ${nb}"

sql = "select count(distinct obj.id) from XWikiDocument as doc, BaseObject as obj where doc.web='${request.space}' and doc.fullName=obj.name and obj.className='XWiki.AggregatorURLClass'"
nb = xwiki.search(sql)[0]
println "* ${msg.get("watch.nbdefinedfeeds")}: ${nb}"

sql = "select count(distinct feedentry.feedname) from XWikiDocument as doc, BaseObject as obj, XWiki.FeedEntryClass as feedentry where  doc.web='${request.space}' and doc.fullName=obj.name and obj.className='XWiki.FeedEntryClass' and obj.id=feedentry.id"
nb = xwiki.search(sql)[0]
println "* ${msg.get("watch.nbdefinedfeedswithdata")}: ${nb}"

println "* ${msg.get("watch.nbloadedfeeds")}: " + updateThread.nbLoadedFeeds
println "* ${msg.get("watch.nbloadedfeedserrors")}: " + updateThread.nbLoadedFeedsErrors
println "* ${msg.get("watch.nbarticlesloaded")}: " + updateThread.nbLoadedArticles
println "* ${msg.get("watch.startdata")}: " + updateThread.startDate
println "* ${msg.get("watch.enddata")}: " + updateThread.endDate
if (updateThread.exception!=null)
 println "* ${msg.get("watch.exception")}: " + updateThread.exception

println "&lt;h2&gt;${msg.get("watch.feeds")}&lt;/h2&gt;"

sql = "select feedentry.feedname, count(*) from XWikiDocument as doc, BaseObject as obj, XWiki.FeedEntryClass as feedentry  where doc.web='${request.space}' and doc.fullName=obj.name and obj.className='XWiki.FeedEntryClass' and obj.id=feedentry.id  group by feedentry.feedname"

println "{table}"
println "${msg.get("watch.feedname")} | ${msg.get("watch.nbarticles")}"
for(data in xwiki.search(sql)) {
 def feedname = data[0]
 def feednb = data[1]
 println "${feedname} | ${feednb}"
}

println "{table}"
}
}
%&gt;</content>
</xwikidoc>
