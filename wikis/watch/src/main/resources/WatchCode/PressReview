<?xml version="1.0" encoding="ISO-8859-1"?>

<xwikidoc>
<web>WatchCode</web>
<name>PressReview</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1181212721000</creationDate>
<date>1195556874000</date>
<contentUpdateDate>1195556874000</contentUpdateDate>
<version>1.13</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<content>&lt;%
if (request.space==null) {
 println "$msg.get("watch.pressreview.noquery")"
} else {
if (request.keyword==null)
 skeyword = ""
else
 skeyword = request.keyword

limit=50;
if (request.limit != null)
 limit = xwiki.parseInt(request.limit)


String skeyword = skeyword.replaceAll("'", "''");
String sql = ", BaseObject as obj, XWiki.FeedEntryClass as feedentry ";
String wheresql = "where doc.fullName=obj.name and obj.className='XWiki.FeedEntryClass' and obj.id=feedentry.id ";
if (!(skeyword.trim()=="")) {
   wheresql  += " and (lower(feedentry.title) like '%" + skeyword.toLowerCase() + "%' or lower(feedentry.content) like '%" + skeyword.toLowerCase() + "%' or lower(feedentry.fullContent) like '%" + skeyword.toLowerCase() + "%') ";
}

if (request.flagged=="1") {
             wheresql += " and feedentry.flag=1";
} else if ((request.flagged=="-1")&amp;&amp;(request.trashed=="-1")) {
            wheresql += " and (feedentry.flag=0 or feedentry.flag is null)";
} else if (request.trashed=="1") {
            wheresql += " and feedentry.flag=-1";
} else if (request.trashed=="-1") {
            wheresql += " and (feedentry.flag&gt;-1 or feedentry.flag is null)";
} else if (request.flagged=="-1") {
            wheresql += " and (feedentry.flag&lt;1 or feedentry.flag is null)";
}

if ((request.feed!=null)&amp;&amp;(!request.feed.trim().equals(""))) {
            wheresql += " and feedentry.feedurl='" + request.feed.replaceAll("'","''") + "'";
} else if ((request.group!=null)&amp;&amp;(!request.group.trim().equals(""))) {
            wheresql += " and feedentry.feedurl in (select feed.url from XWiki.AggregatorURLClass as feed where '" + request.group.replaceAll("'","''") + "' in elements(feed.group))"; 
}

if (request.tags!=null) {
 for(tag in request.getParameterValues("tags")) {
  wheresql += " and '" + tag.replaceAll("'","''") + "' in elements(feedentry.tags) ";
 }
}

if (request.read=="1") {
  wheresql += " and feedentry.read=1";
}
if (request.read=="-1") {
   wheresql += " and (feedentry.read is null or feedentry.read=0)";
}


if (request.dateStart) {
  wheresql += " and feedentry.date &gt;= '" + request.dateStart + "' ";
}

if (request.dateEnd) {
  wheresql += " and feedentry.date &lt;= '" + request.dateEnd + "' ";
}


println "{pre}"

sql += wheresql + " and doc.web='" + request.space + "' order by feedentry.date desc, doc.creationDate desc";
for(item in xwiki.searchDocuments(sql, limit, 0)) {
  itemdoc = xwiki.getDocument(item)
  itemdoc.use("XWiki.FeedEntryClass")
  atitle = itemdoc.display("title")
  url = itemdoc.display("url")
  feedname = itemdoc.display("feedname")
  println "&lt;div class='article'&gt;&lt;span class='article-title'&gt;&lt;a class='article-url' href=\"${url}\"&gt;${atitle}&lt;/a&gt; $msg.get("watch.pressreview.in") ${feedname}&lt;/span&gt;"
  if ("1".equals(request.withcontent)) {
    println "&lt;p class='article-content'&gt;"
    println itemdoc.display("content")
    println "&lt;/p&gt;"
  }
  def comments = itemdoc.getComments(true)
  if (!"0".equals(request.withcomments)) {
  if (comments.size()&gt;0) {
   println "&lt;ul class='article-comments'&gt;"
   for (comment in comments) { 
    itemdoc.use(comment)
    author = xwiki.getLocalUserName(itemdoc.display("author", "view"))  
    println "&lt;li&gt;&lt;span class='article-comment'&gt;" + itemdoc.display("comment", "view") + "&lt;/span&gt; $msg.get("watch.pressreview.by") &lt;span class='article-comment-author'&gt;" + author + "&lt;/span&gt;&lt;/li&gt;"
   }
   println "&lt;/ul&gt;"
  }
  }
  println "&lt;/div&gt;"
 }
 println "{/pre}"
}
%&gt;&amp;nbsp;</content>
</xwikidoc>
